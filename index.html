<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Gemini Office v13 - Gemini 3 Edition</title>
    
    <!-- Core Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Syntax Highlighting (Prism) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

    <!-- Math Rendering (KaTeX) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@500;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root { --accent: #3b82f6; --glass-border: rgba(255, 255, 255, 0.08); --glass-bg: rgba(10, 10, 20, 0.6); }
        * { font-family: 'Inter', sans-serif; }
        h1, h2, h3, .font-heading { font-family: 'Outfit', sans-serif; }
        code, pre, .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        body { background-color: #020617; color: #e2e8f0; overflow: hidden; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Typography & Markdown */
        .prose h1 { font-family: 'Outfit', sans-serif; font-size: 2rem; font-weight: 800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 1.5rem 0 1rem; }
        .prose h2 { font-size: 1.5rem; font-weight: 700; color: #f1f5f9; margin: 1.5rem 0 0.8rem; }
        .prose h3 { font-size: 1.25rem; font-weight: 600; color: #60a5fa; margin: 1.25rem 0 0.6rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.7; color: #cbd5e1; }
        .prose ul { list-style: disc; padding-left: 1.5rem; margin-bottom: 1rem; marker: #3b82f6; }
        .prose li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; color: #94a3b8; }
        .prose li::before { content: "•"; position: absolute; left: 0; color: #3b82f6; font-weight: bold; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose blockquote { border-left: 4px solid #3b82f6; padding: 0.5rem 0 0.5rem 1rem; margin: 1.5rem 0; background: linear-gradient(90deg, rgba(59,130,246,0.1), transparent); border-radius: 0 8px 8px 0; font-style: italic; color: #e2e8f0; }
        
        /* Prism Fixes */
        pre[class*="language-"] { background: #0f172a !important; border: 1px solid var(--glass-border); border-radius: 8px; margin: 1.5rem 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        code[class*="language-"], pre[class*="language-"] { font-family: 'JetBrains Mono', monospace; font-size: 0.9em; text-shadow: none; }
        .prose :not(pre) > code { background: rgba(30, 41, 59, 0.5); padding: 0.2rem 0.4rem; border-radius: 4px; border: 1px solid var(--glass-border); color: #93c5fd; font-size: 0.9em; }

        .prose table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--glass-border); border-radius: 8px; overflow: hidden; margin: 1.5rem 0; }
        .prose th { background: rgba(30, 41, 59, 0.8); padding: 0.75rem; text-align: left; color: #fff; border-bottom: 1px solid var(--glass-border); }
        .prose td { padding: 0.75rem; border-bottom: 1px solid var(--glass-border); color: #cbd5e1; }
        
        /* Visual Components */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(16px); border: 1px solid var(--glass-border); }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
        .metric-card { background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 1rem; border-radius: 12px; transition: all 0.2s; }
        .metric-card:hover { background: rgba(255,255,255,0.06); transform: translateY(-2px); border-color: rgba(59, 130, 246, 0.3); }
        .metric-val { font-family: 'Outfit', sans-serif; font-size: 1.25rem; font-weight: 700; color: #fff; }
        .metric-lbl { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; font-weight: 600; }

        .reasoning-box { margin-bottom: 1rem; border: 1px solid rgba(147, 51, 234, 0.2); background: rgba(147, 51, 234, 0.05); border-radius: 8px; overflow: hidden; }
        .reasoning-header { padding: 0.5rem 1rem; background: rgba(147, 51, 234, 0.1); color: #d8b4fe; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .reasoning-content { padding: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #c084fc; line-height: 1.6; display: none; border-top: 1px solid rgba(147, 51, 234, 0.1); }
        .reasoning-box.open .reasoning-content { display: block; }

        .typing-cursor::after { content: '▋'; animation: blink 1s infinite; color: #3b82f6; margin-left: 2px; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Canvas */
        #canvasOverlay { backdrop-filter: blur(24px); background: rgba(2, 6, 23, 0.98); }
        .slide-card { aspect-ratio: 16/9; background: white; border-radius: 8px; overflow: hidden; position: relative; box-shadow: 0 20px 50px -12px rgba(0,0,0,0.7); }
        .layout-title { background: #0f172a; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 4rem; position: relative; }
        .layout-title::after { content: ''; position: absolute; right: 0; top: 0; width: 60%; height: 100%; background: linear-gradient(135deg, rgba(59,130,246,0.15), transparent); clip-path: polygon(25% 0, 100% 0, 100% 100%, 0% 100%); }
        .layout-split { display: grid; grid-template-columns: 40% 60%; height: 100%; }
        .layout-content { padding: 3rem; display: flex; flex-direction: column; justify-content: center; background: white; color: #0f172a; }
        .layout-img { width: 100%; height: 100%; object-fit: cover; }

        /* Loader */
        .loader-ring { width: 16px; height: 16px; border: 2px solid #3b82f6; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Toast */
        .toast { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); z-index: 100; transform: translateX(150%); transition: all 0.3s; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.5); }
        .toast.show { transform: translateX(0); }

        /* Drag Overlay */
        #dragOverlay { pointer-events: none; opacity: 0; transition: opacity 0.2s; background: rgba(59, 130, 246, 0.1); border: 2px dashed #3b82f6; z-index: 40; }
        .drag-active #dragOverlay { opacity: 1; }
    </style>
</head>
<body class="flex flex-col h-screen bg-[#020617] bg-[radial-gradient(circle_at_top,_rgba(59,130,246,0.1),transparent_50%)]" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">

    <!-- Drag Overlay -->
    <div id="dragOverlay" class="fixed inset-4 rounded-3xl flex items-center justify-center">
        <div class="bg-slate-900/90 backdrop-blur-xl p-6 rounded-2xl border border-blue-500/50 shadow-2xl flex flex-col items-center gap-4">
            <div class="w-16 h-16 bg-blue-500/20 rounded-full flex items-center justify-center animate-bounce">
                <i data-lucide="upload-cloud" class="w-8 h-8 text-blue-400"></i>
            </div>
            <h3 class="text-xl font-bold text-white">Drop to Analyze</h3>
            <p class="text-blue-200">PDF, Excel, Images supported</p>
        </div>
    </div>

    <!-- Header -->
    <header class="h-14 glass-panel border-b-0 border-b-white/5 flex items-center justify-between px-6 sticky top-0 z-30">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-indigo-500 to-blue-600 p-2 rounded-lg shadow-lg shadow-blue-500/20"><i data-lucide="bot" class="w-5 h-5 text-white"></i></div>
            <h1 class="font-heading font-bold text-lg text-white tracking-tight">Super Gemini <span class="text-slate-500 text-xs font-normal ml-1">v13</span></h1>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="clearChat()" class="p-2 hover:bg-white/5 rounded-lg text-slate-400 hover:text-red-400 transition-colors" title="Clear Chat"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            <div class="h-5 w-px bg-white/10"></div>
            <button onclick="toggleSettings()" id="keyStatus" class="flex items-center gap-2 px-3 py-1.5 rounded-lg border border-dashed border-slate-700 hover:border-slate-500 text-xs font-medium text-slate-400 transition-all">
                <div class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></div> API Key
            </button>
        </div>
    </header>

    <!-- Canvas -->
    <div id="canvasOverlay" class="hidden fixed inset-0 z-50 flex flex-col p-6 opacity-0 transition-opacity duration-300">
        <div class="w-full flex justify-between items-center mb-6 bg-slate-900/90 p-4 rounded-xl border border-white/10 shadow-2xl backdrop-blur-md">
            <div class="flex items-center gap-4">
                <h2 class="text-lg font-bold text-white flex items-center gap-2 font-heading"><i data-lucide="presentation" class="w-5 h-5 text-blue-400"></i> Canvas</h2>
                <div class="h-5 w-px bg-white/10"></div>
                <div class="flex gap-1 bg-slate-800 p-1 rounded-lg border border-white/5">
                    <button onclick="setCanvasView('focus')" id="btnFocus" class="p-1.5 rounded bg-slate-700 text-white shadow-sm"><i data-lucide="monitor" class="w-4 h-4"></i></button>
                    <button onclick="setCanvasView('grid')" id="btnGrid" class="p-1.5 rounded text-slate-400 hover:text-white"><i data-lucide="grid" class="w-4 h-4"></i></button>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="downloadPPTFromCanvas()" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg flex items-center gap-2 text-xs font-bold uppercase tracking-wider transition-all shadow-lg shadow-blue-500/20"><i data-lucide="download" class="w-4 h-4"></i> Export PPTX</button>
                <button onclick="closeCanvas()" class="p-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg border border-white/10"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
        </div>
        
        <div class="flex-1 relative overflow-hidden flex items-center justify-center outline-none" tabindex="0" id="canvasContainer" onkeydown="handleCanvasKey(event)">
            <div id="focusView" class="relative w-full max-w-6xl aspect-video bg-black rounded-xl shadow-2xl overflow-hidden border border-slate-700 ring-1 ring-white/10 transition-all">
                <div id="canvasSlideContainer" class="w-full h-full"></div>
                <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-4 bg-slate-900/90 backdrop-blur-xl px-4 py-2 rounded-full border border-white/10 shadow-2xl z-20">
                    <button onclick="prevSlide()" class="p-2 hover:bg-white/10 rounded-full text-slate-300 hover:text-white"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                    <span class="text-xs font-mono text-slate-400"><span id="currSlide" class="text-white font-bold">1</span> / <span id="totalSlide">1</span></span>
                    <button onclick="nextSlide()" class="p-2 hover:bg-white/10 rounded-full text-slate-300 hover:text-white"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                </div>
            </div>
            <div id="gridView" class="hidden w-full h-full overflow-y-auto custom-scroll"><div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-3 xl:grid-cols-4 gap-6 p-4 pb-20"></div></div>
        </div>
    </div>

    <!-- Settings -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-all duration-300 opacity-0">
        <div class="bg-slate-900 border border-white/10 p-6 rounded-2xl w-full max-w-md shadow-2xl transform scale-95 transition-all duration-300">
            <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2 font-heading"><i data-lucide="shield-check" class="w-5 h-5 text-emerald-500"></i> Setup</h2>
            <div class="space-y-4">
                <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key..." class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:outline-none focus:border-blue-500 font-mono transition-all">
                <div class="flex gap-3">
                    <button onclick="saveSettings()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-medium py-2.5 rounded-xl transition-all shadow-lg shadow-blue-500/20">Save Securely</button>
                    <button onclick="toggleSettings()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 font-medium py-2.5 rounded-xl transition-all">Cancel</button>
                </div>
                <p class="text-[10px] text-slate-500 text-center">Key is stored strictly in your browser's local storage.</p>
            </div>
        </div>
    </div>

    <!-- Main -->
    <main class="flex-1 overflow-hidden relative flex flex-col w-full max-w-5xl mx-auto">
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 sm:p-8 space-y-8 scroll-smooth custom-scroll w-full">
            <div id="welcomeScreen" class="min-h-[60vh] flex flex-col items-center justify-center text-center p-4 animate-fade-in">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-3xl flex items-center justify-center shadow-2xl shadow-blue-500/20 mb-6 border border-white/10 relative group">
                    <div class="absolute inset-0 bg-white/20 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-700"></div>
                    <i data-lucide="sparkles" class="w-10 h-10 text-white relative z-10"></i>
                </div>
                <h2 class="text-3xl font-bold text-white mb-3 tracking-tight font-heading">Super Gemini Office</h2>
                <p class="text-slate-400 max-w-md mb-8 text-sm leading-relaxed">
                    <strong>v13 Gemini 3 Edition</strong>.<br>Math, Code, Canvas, and Infinite Streaming.
                </p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 w-full max-w-3xl">
                    <button onclick="setMode('presentation')" class="group p-4 bg-slate-900/50 hover:bg-blue-600/10 border border-white/5 hover:border-blue-500/50 rounded-xl text-left transition-all relative overflow-hidden"><i data-lucide="presentation" class="w-5 h-5 text-blue-400 mb-3 group-hover:scale-110 transition-transform"></i><h3 class="text-xs font-bold text-white uppercase tracking-wider mb-1">Presentation</h3><p class="text-[10px] text-slate-500 group-hover:text-blue-200">Canvas + Images</p></button>
                    <button onclick="setMode('analyze')" class="group p-4 bg-slate-900/50 hover:bg-emerald-600/10 border border-white/5 hover:border-emerald-500/50 rounded-xl text-left transition-all relative overflow-hidden"><i data-lucide="bar-chart-2" class="w-5 h-5 text-emerald-400 mb-3 group-hover:scale-110 transition-transform"></i><h3 class="text-xs font-bold text-white uppercase tracking-wider mb-1">Analytics</h3><p class="text-[10px] text-slate-500 group-hover:text-emerald-200">Data + Visuals</p></button>
                    <button onclick="setMode('report')" class="group p-4 bg-slate-900/50 hover:bg-purple-600/10 border border-white/5 hover:border-purple-500/50 rounded-xl text-left transition-all relative overflow-hidden"><i data-lucide="file-text" class="w-5 h-5 text-purple-400 mb-3 group-hover:scale-110 transition-transform"></i><h3 class="text-xs font-bold text-white uppercase tracking-wider mb-1">Reports</h3><p class="text-[10px] text-slate-500 group-hover:text-purple-200">Infinite Docs</p></button>
                    <button onclick="setMode('image')" class="group p-4 bg-slate-900/50 hover:bg-amber-600/10 border border-white/5 hover:border-amber-500/50 rounded-xl text-left transition-all relative overflow-hidden"><i data-lucide="image" class="w-5 h-5 text-amber-400 mb-3 group-hover:scale-110 transition-transform"></i><h3 class="text-xs font-bold text-white uppercase tracking-wider mb-1">Studio</h3><p class="text-[10px] text-slate-500 group-hover:text-amber-200">Nano Art</p></button>
                </div>
            </div>
            <div id="messagesArea" class="flex flex-col gap-8 pb-4 w-full"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-[#020617]/80 backdrop-blur-xl border-t border-white/5 p-4 pb-6 z-20">
        <div class="max-w-4xl mx-auto w-full space-y-3">
            <div class="flex items-center justify-between px-1">
                <div class="flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer group select-none bg-slate-900/50 border border-white/5 px-2 py-1 rounded-md transition-colors hover:border-blue-500/30">
                        <input type="checkbox" id="humanizerToggle" class="peer sr-only">
                        <div class="w-2 h-2 rounded-full bg-slate-600 peer-checked:bg-blue-500 transition-colors"></div>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 peer-checked:text-blue-400">Humanizer</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group select-none bg-slate-900/50 border border-white/5 px-2 py-1 rounded-md transition-colors hover:border-purple-500/30">
                        <input type="checkbox" id="cotToggle" class="peer sr-only">
                        <div class="w-2 h-2 rounded-full bg-slate-600 peer-checked:bg-purple-500 transition-colors"></div>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 peer-checked:text-purple-400">Deep Think</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group select-none bg-slate-900/50 border border-white/5 px-2 py-1 rounded-md transition-colors hover:border-emerald-500/30">
                        <input type="checkbox" id="webToggle" class="peer sr-only">
                        <div class="w-2 h-2 rounded-full bg-slate-600 peer-checked:bg-emerald-500 transition-colors"></div>
                        <span class="text-[10px] font-bold uppercase tracking-wider text-slate-400 peer-checked:text-emerald-400">Web</span>
                    </label>
                </div>
                <button id="nanoBtn" onclick="toggleNano()" class="text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 px-2 py-1 rounded-md border border-white/5 bg-slate-900/50 text-slate-400 hover:text-white transition-all select-none">
                    <i data-lucide="image" class="w-3 h-3"></i> <span>Nano Off</span>
                </button>
            </div>
            <div id="attachmentPreview" class="hidden animate-fade-in flex items-center gap-3 bg-slate-900 border border-white/10 p-2 pl-3 rounded-lg w-fit shadow-lg">
                <div class="flex items-center gap-2"><i id="attIcon" data-lucide="file" class="w-4 h-4 text-blue-400"></i><span id="attName" class="text-xs font-medium text-white max-w-[150px] truncate">File</span></div>
                <button onclick="clearAttachment()" class="p-1 hover:bg-white/10 rounded-md text-slate-400 hover:text-red-400"><i data-lucide="x" class="w-3 h-3"></i></button>
            </div>
            <div class="relative group">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 to-indigo-600/10 rounded-2xl blur opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
                <div class="relative flex items-end gap-2 bg-slate-900 border border-slate-800 group-focus-within:border-slate-600 rounded-2xl p-2 transition-all shadow-xl">
                    <button onclick="document.getElementById('fileInput').click()" class="p-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i data-lucide="paperclip" class="w-5 h-5"></i></button>
                    <input type="file" id="fileInput" class="hidden" onchange="handleFile(event)" accept=".pdf,.xlsx,.xls,image/*">
                    <textarea id="promptInput" rows="1" placeholder="Ask Super Gemini..." class="w-full bg-transparent border-none focus:ring-0 resize-none py-3 text-slate-200 placeholder:text-slate-600 max-h-32 custom-scroll text-sm" oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                    <button id="micBtn" onclick="toggleMic()" class="p-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors"><i data-lucide="mic" class="w-5 h-5"></i></button>
                    <button id="actionBtn" onclick="handleAction()" class="p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl shadow-lg shadow-blue-500/20 transition-all hover:scale-105 active:scale-95 disabled:opacity-50"><i data-lucide="arrow-up" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>
    </footer>

    <div id="toast" class="toast"></div>

    <script>
        // --- State ---
        let API_KEY = localStorage.getItem('GEMINI_API_KEY') || '';
        let chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
        let currentAttachment = null;
        let isNanoBanana = false;
        let isWebEnabled = false;
        let isCoTEnabled = false;
        let isHumanizerEnabled = false;
        let currentMode = 'chat';
        let activeSlides = [];
        let currentSlideIndex = 0;
        let isRecording = false;
        let recognition = null;
        let abortController = null;
        let isGenerating = false;

        // Updated Models - Using the newly available Gemini 3 Preview
        const MODEL_TEXT = 'gemini-3-pro-preview'; 
        const MODEL_IMAGE = 'gemini-3-pro-image-preview';

        // --- System Prompts ---
        const SYS_PROMPT_BASE = `
You are Super Gemini Office.
Output must be professional, structured, and visually appealing.
- Use Markdown headers (#).
- Use **bold** for emphasis.
- Extract metrics as: ::METRIC:: Label | Value
- If user asks for data analysis, ALWAYS end with an image prompt for an infographic wrapped in: :::IMG_PROMPT::: infographic description :::END:::
- Format equations using LaTeX syntax: $E=mc^2$ or $$ \int_0^\infty x^2 dx $$
`;

        const SYS_PROMPT_HUMANIZER = `
You are an expert human writer. Rewrite the text to be undetectable by AI detectors.
- Use varied vocabulary and unexpected word choices.
- Vary sentence length dramatically.
- Add authentic human imperfections, idioms, and conversational flow.
- Infuse emotional intelligence and personal tone.
`;

        const SYS_PROMPT_COT = `
You are a Deep Reasoning AI.
Before answering, you MUST provide a Chain-of-Thought (CoT) enclosed in <thought> tags.
1. Deconstruct the request.
2. Outline plan.
3. Identify key logic.
4. Draft structure.
Then provide the answer.
`;

        const SYS_PROMPT_PRES = `
You are a Presentation Architect. Output strictly VALID JSON array of slide objects. No markdown.
[
  {
    "layout": "title" | "split_right" | "split_left" | "big_number",
    "title": "Title",
    "subtitle": "Subtitle",
    "points": ["Point 1", "Point 2"],
    "image_prompt": "Photorealistic 8k render of [Topic]"
  }
]
Create 5-8 slides.
`;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            updateKeyStatus();
            if(!API_KEY) setTimeout(toggleSettings, 800);
            
            // Restore History
            if(chatHistory.length > 0) {
                document.getElementById('welcomeScreen').classList.add('hidden');
                chatHistory.forEach(msg => {
                    if(msg.role === 'user') appendUserMessage(msg.parts[0].text);
                    else if(msg.role === 'model') finalizeBotMessage(msg.parts[0].text, false); 
                });
                scrollToBottom();
            }

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = false;
                recognition.onresult = (e) => {
                    const txt = e.results[0][0].transcript;
                    const el = document.getElementById('promptInput');
                    el.value += (el.value ? ' ' : '') + txt;
                    autoResize(el);
                };
                recognition.onend = () => { isRecording = false; updateMicIcon(); };
            }
            
            document.getElementById('cotToggle').addEventListener('change', (e) => isCoTEnabled = e.target.checked);
            document.getElementById('webToggle').addEventListener('change', (e) => isWebEnabled = e.target.checked);
            document.getElementById('humanizerToggle').addEventListener('change', (e) => isHumanizerEnabled = e.target.checked);
        });

        // --- Drag & Drop ---
        function handleDragOver(e) { e.preventDefault(); document.body.classList.add('drag-active'); }
        function handleDragLeave(e) { e.preventDefault(); document.body.classList.remove('drag-active'); }
        function handleDrop(e) {
            e.preventDefault();
            document.body.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            if(files.length > 0) handleFile({target: {files: files}});
        }

        // --- UI & Settings ---
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            m.classList.toggle('hidden');
            setTimeout(() => { m.classList.toggle('opacity-0'); m.querySelector('div').classList.toggle('scale-95'); }, 10);
            if (!m.classList.contains('hidden')) document.getElementById('apiKeyInput').value = API_KEY;
        }

        function saveSettings() {
            const k = document.getElementById('apiKeyInput').value.trim();
            if(!k) return showToast('API Key required', 'error');
            localStorage.setItem('GEMINI_API_KEY', k);
            API_KEY = k;
            updateKeyStatus();
            toggleSettings();
            showToast('Saved', 'success');
        }

        function updateKeyStatus() {
            const el = document.getElementById('keyStatus');
            if(API_KEY) {
                el.innerHTML = `<div class="w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]"></div> Ready`;
                el.classList.add('border-emerald-500/30', 'text-emerald-400');
            }
        }

        function clearChat() {
            if(confirm("Clear history?")) {
                chatHistory = [];
                localStorage.removeItem('chat_history');
                document.getElementById('messagesArea').innerHTML = '';
                document.getElementById('welcomeScreen').classList.remove('hidden');
            }
        }

        function setMode(mode) {
            currentMode = mode;
            const input = document.getElementById('promptInput');
            const prompts = {
                presentation: "Create a pitch deck for [Topic].",
                analyze: "Analyze the attached data.",
                report: "Write a comprehensive report about [Topic].",
                image: "A futuristic cityscape..."
            };
            
            if (mode === 'image' && !isNanoBanana) toggleNano();
            if (mode !== 'image' && isNanoBanana) toggleNano();
            
            input.value = prompts[mode] || "";
            autoResize(input);
            input.focus();
            const idx = input.value.indexOf("[Topic]");
            if (idx !== -1) input.setSelectionRange(idx, idx + 7);
        }

        function toggleNano() {
            isNanoBanana = !isNanoBanana;
            const btn = document.getElementById('nanoBtn');
            const input = document.getElementById('promptInput');
            if (isNanoBanana) {
                btn.innerHTML = '<i data-lucide="sparkles" class="w-3.5 h-3.5 text-yellow-400"></i> <span class="text-yellow-100">Nano ON</span>';
                btn.className = "text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 px-2 py-1 rounded-md border border-yellow-500/30 bg-yellow-500/10 text-yellow-400 shadow-[0_0_15px_rgba(234,179,8,0.2)] transition-all select-none";
                input.placeholder = "Describe visual...";
                currentMode = 'image';
            } else {
                btn.innerHTML = '<i data-lucide="image" class="w-3.5 h-3.5"></i> <span>Nano Off</span>';
                btn.className = "text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 px-2 py-1 rounded-md border border-white/5 bg-slate-900/50 text-slate-400 hover:text-white transition-all select-none";
                input.placeholder = "Type a message...";
                currentMode = 'chat';
            }
            lucide.createIcons();
        }

        // --- Core Logic ---
        function handleAction() {
            if (isGenerating) {
                if (abortController) abortController.abort();
                isGenerating = false;
                document.getElementById('actionBtn').innerHTML = `<i data-lucide="arrow-up" class="w-5 h-5"></i>`;
                lucide.createIcons();
                showToast("Stopped", "info");
            } else {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('promptInput');
            const text = input.value.trim();
            if(!text && !currentAttachment) return;
            if(!API_KEY) return toggleSettings();

            document.getElementById('welcomeScreen').classList.add('hidden');
            appendUserMessage(text, currentAttachment);
            input.value = '';
            input.style.height = 'auto';
            const att = currentAttachment;
            clearAttachment();

            let intent = currentMode;
            if (intent === 'chat') {
                const lower = text.toLowerCase();
                if (lower.includes('presentation') || lower.includes('deck')) intent = 'presentation';
                else if (lower.includes('image')) intent = 'image';
            }

            if (intent === 'presentation') await handlePresentation(text, att);
            else if (intent === 'image') await handleImage(text);
            else {
                createBotMessagePlaceholder();
                await streamGemini(text, (chunk) => updateBotMessage(chunk), (final, err) => {
                    if(err) updateBotMessage(final, true);
                    else finalizeBotMessage(final);
                }, att);
            }
        }

        // --- Streaming Chat ---
        async function streamGemini(prompt, onChunk, onComplete, attachment) {
            try {
                isGenerating = true;
                document.getElementById('actionBtn').innerHTML = `<i data-lucide="square" class="w-3 h-3 fill-white"></i>`;
                lucide.createIcons();
                
                abortController = new AbortController();
                const parts = [{text: prompt}];
                if (attachment) {
                    if (attachment.name.match(/\.xls(x)?$/)) {
                        const csv = await readExcel(attachment);
                        parts.push({ text: `\n\n[Data]:\n${csv}` });
                    } else {
                        const b64 = await fileToBase64(attachment);
                        parts.push({ inlineData: { mimeType: attachment.type, data: b64 } });
                    }
                }

                if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20);
                const contents = [...chatHistory, { role: 'user', parts }];
                const tools = isWebEnabled ? [{ google_search: {} }] : undefined;
                
                const sysParts = [];
                if (isHumanizerEnabled) sysParts.push({ text: SYS_PROMPT_HUMANIZER });
                else sysParts.push({ text: SYS_PROMPT_BASE });
                
                if (isCoTEnabled) sysParts.push({ text: SYS_PROMPT_COT });

                // Added &alt=sse to force SSE response format for reliable parsing
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:streamGenerateContent?key=${API_KEY}&alt=sse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents, systemInstruction: { parts: sysParts }, tools }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error("API Error " + response.status);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        const clean = line.replace(/^data: /, '').trim();
                        if (!clean) continue;
                        try {
                            const json = JSON.parse(clean);
                            const t = json.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (t) { fullText += t; onChunk(fullText); }
                        } catch (e) {}
                    }
                }

                chatHistory.push({ role: 'user', parts: [{ text: prompt }] });
                chatHistory.push({ role: 'model', parts: [{ text: fullText }] });
                localStorage.setItem('chat_history', JSON.stringify(chatHistory));
                
                onComplete(fullText);

            } catch (e) {
                if (e.name !== 'AbortError') onComplete("Error: " + e.message, true);
            } finally {
                isGenerating = false;
                document.getElementById('actionBtn').innerHTML = `<i data-lucide="arrow-up" class="w-5 h-5"></i>`;
                lucide.createIcons();
            }
        }

        // --- Presentation ---
        async function handlePresentation(text, att) {
            createBotMessagePlaceholder();
            updateBotMessage("Architecting deck...");
            try {
                const parts = [{text: text}];
                if (att) {
                    if (att.name.match(/\.xls(x)?$/)) {
                        const csv = await readExcel(att);
                        parts.push({ text: `\n\n[Data]:\n${csv}` });
                    } else {
                        const b64 = await fileToBase64(att);
                        parts.push({ inlineData: { mimeType: att.type, data: b64 } });
                    }
                }
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TEXT}:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{parts}], systemInstruction: { parts: [{text: SYS_PROMPT_PRES}] } })
                });
                const data = await res.json();
                let raw = data.candidates[0].content.parts[0].text;
                let slides = [];
                try {
                    slides = JSON.parse(raw.replace(/```json/g, '').replace(/```/g, '').trim());
                } catch(e) {
                    updateBotMessage(raw); // Fallback
                    return;
                }

                updateBotMessage(`Designing ${slides.length} slides with visuals...`);
                
                for(let i=0; i<slides.length; i++) {
                    if(slides[i].image_prompt) {
                        try {
                            // Using predict endpoint for image model, consistent with previous versions
                            const imgRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:predict?key=${API_KEY}`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ instances: [{ prompt: slides[i].image_prompt }], parameters: { sampleCount: 1 } })
                            });
                            const imgData = await imgRes.json();
                            if(imgData.predictions) slides[i].imageData = `data:image/png;base64,${imgData.predictions[0].bytesBase64Encoded}`;
                        } catch(e) {}
                    }
                }
                
                const ph = document.getElementById('current-bot-message');
                if(ph) ph.parentElement.remove();
                appendPresentationCard(slides);

            } catch(e) { updateBotMessage(e.message, true); }
        }

        // --- Image ---
        async function handleImage(text) {
            createBotMessagePlaceholder();
            updateBotMessage("Generating...");
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:predict?key=${API_KEY}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instances: [{ prompt: text }], parameters: { sampleCount: 1 } })
                });
                const data = await res.json();
                if(!data.predictions) throw new Error("Gen Failed");
                const ph = document.getElementById('current-bot-message');
                if(ph) ph.parentElement.remove();
                appendImageCard(`data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`, text);
            } catch(e) { updateBotMessage(e.message, true); }
        }

        // --- Parsing & Rendering ---
        function parseResponse(text) {
            let reasoning = null;
            let content = text;
            let imgPrompt = null;
            let metrics = [];

            // Extract Thought
            const thoughtMatch = text.match(/<ctrl3347>([\s\S]*?)<\/thought>/);
            if (thoughtMatch) {
                reasoning = thoughtMatch[1].trim();
                content = text.replace(/<\ctrl3347>[\s\S]*?<\/thought>/, '').trim();
            }

            // Extract Img Prompt
            const imgMatch = content.match(/:::IMG_PROMPT:::(.*?):::END:::/s);
            if (imgMatch) {
                imgPrompt = imgMatch[1].trim();
                content = content.replace(/:::IMG_PROMPT:::.*?:::END:::/s, '').trim();
            }

            // Extract Metrics
            const lines = content.split('\n');
            const cleanLines = [];
            lines.forEach(l => {
                if(l.includes('::METRIC::')) {
                    const p = l.replace('::METRIC::','').split('|');
                    if(p.length===2) metrics.push({label: p[0].trim(), value: p[1].trim()});
                } else cleanLines.push(l);
            });
            content = cleanLines.join('\n');

            return { reasoning, content, imgPrompt, metrics };
        }

        function appendUserMessage(text, att) {
            const div = document.createElement('div');
            div.className = "flex justify-end animate-fade-in";
            div.innerHTML = `<div class="max-w-[85%] bg-blue-600 text-white p-4 rounded-2xl rounded-tr-sm shadow-xl shadow-blue-900/20 text-sm leading-relaxed">${att ? `<div class="flex items-center gap-2 bg-blue-700/50 p-2 rounded-lg mb-2 text-xs border border-white/10"><i data-lucide="paperclip" class="w-3 h-3"></i> ${att.name}</div>` : ''}<p class="whitespace-pre-wrap">${text}</p></div>`;
            document.getElementById('messagesArea').appendChild(div);
            scrollToBottom();
        }

        function createBotMessagePlaceholder() {
            const div = document.createElement('div');
            div.className = "flex gap-4 animate-fade-in";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-indigo-500/20 mt-1"><i data-lucide="bot" class="w-4 h-4 text-white"></i></div><div class="max-w-[85%] w-full"><div class="bg-slate-900 border border-slate-800 p-6 rounded-2xl rounded-tl-sm shadow-sm" id="current-bot-message"><div class="flex items-center gap-2 text-slate-400 text-sm"><div class="loader-ring"></div> Thinking...</div></div></div>`;
            document.getElementById('messagesArea').appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        function updateBotMessage(text, isError=false) {
            const c = document.getElementById('current-bot-message');
            if(!c) return;
            if(isError) c.innerHTML = `<div class="text-red-400 flex items-center gap-2"><i data-lucide="alert-triangle" class="w-4 h-4"></i> ${text}</div>`;
            else {
                let display = text;
                if(text.includes('</thought>')) display = text.split('<ctrl3348>')[1] || "Analyzed request. Generating response...";
                c.innerHTML = `<div class="prose prose-invert prose-sm max-w-none text-slate-300"><span class="typing-cursor"></span>${marked.parse(display)}</div>`;
                
                // Prism Highlight
                c.querySelectorAll('pre code').forEach((block) => {
                    if(typeof Prism !== 'undefined') Prism.highlightElement(block);
                });
                
                // Math Render
                if(typeof renderMathInElement !== 'undefined') {
                    renderMathInElement(c, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            }
            lucide.createIcons();
            scrollToBottom();
        }

        async function finalizeBotMessage(text, save=true) {
            const c = document.getElementById('current-bot-message');
            if(!c) return;
            const { reasoning, content, imgPrompt, metrics } = parseResponse(text);
            const id = 'msg-' + Date.now();

            let html = '';
            if(reasoning) {
                html += `<div class="reasoning-box"><div class="reasoning-header" onclick="this.parentElement.classList.toggle('open')"><i data-lucide="brain-circuit" class="w-4 h-4 text-purple-400"></i> Analysis <i data-lucide="chevron-right" class="arrow w-3 h-3 ml-auto"></i></div><div class="reasoning-content">${reasoning}</div></div>`;
            }
            if(metrics.length > 0) {
                html += `<div class="metric-grid">${metrics.map(m=>`<div class="metric-card"><div class="metric-lbl">${m.label}</div><div class="metric-val">${m.value}</div></div>`).join('')}</div>`;
            }
            html += `<div class="prose prose-invert prose-sm max-w-none text-slate-300" id="content-${id}">${marked.parse(content)}</div>`;
            
            html += `<div class="mt-6 pt-4 border-t border-white/5 flex gap-2 opacity-80 hover:opacity-100 transition-opacity">
                <button onclick="continueGen()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-indigo-500/20 border border-indigo-500/30 text-indigo-300 text-xs hover:bg-indigo-500/30 transition-all"><i data-lucide="fast-forward" class="w-3.5 h-3.5"></i> Continue</button>
                <button onclick="exportDoc('content-${id}','docx')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-xs hover:text-white transition-all"><i data-lucide="file-text" class="w-3.5 h-3.5"></i> DOCX</button>
                <button onclick="speakText('content-${id}')" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 text-xs hover:text-white transition-all"><i data-lucide="volume-2" class="w-3.5 h-3.5"></i></button>
            </div>`;

            c.innerHTML = html;
            c.removeAttribute('id');
            
            // Post-Render Effects
            c.querySelectorAll('pre code').forEach((block) => { if(typeof Prism !== 'undefined') Prism.highlightElement(block); });
            if(typeof renderMathInElement !== 'undefined') {
                renderMathInElement(c, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}] });
            }
            lucide.createIcons();

            if(imgPrompt && save) {
                const imgDiv = document.createElement('div');
                imgDiv.className = "mt-4 bg-slate-800/50 border border-white/5 p-2 rounded-xl w-fit animate-fade-in";
                imgDiv.innerHTML = `<div class="flex items-center gap-2 text-xs text-slate-400 p-2"><div class="loader-ring w-3 h-3"></div> Generating Visual...</div>`;
                c.appendChild(imgDiv);
                
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_IMAGE}:predict?key=${API_KEY}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ instances: [{ prompt: imgPrompt }], parameters: { sampleCount: 1 } })
                    });
                    const d = await res.json();
                    if(d.predictions) {
                        imgDiv.innerHTML = `<img src="data:image/png;base64,${d.predictions[0].bytesBase64Encoded}" class="rounded-lg shadow-lg max-w-md w-full" />`;
                    } else imgDiv.remove();
                } catch(e) { imgDiv.remove(); }
            }
        }

        // --- Helpers ---
        function appendPresentationCard(slides) {
            activeSlides = slides;
            const div = document.createElement('div');
            div.className = "flex gap-4 w-full max-w-4xl mx-auto animate-fade-in";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-blue-600 flex items-center justify-center shrink-0 shadow-lg shadow-indigo-500/20 mt-1"><i data-lucide="presentation" class="w-4 h-4 text-white"></i></div><div class="w-full max-w-2xl bg-slate-900 border border-slate-700 p-0 rounded-2xl overflow-hidden shadow-2xl hover:border-blue-500/30 transition-colors cursor-default"><div class="p-4 border-b border-slate-800 bg-slate-950/50 flex justify-between items-center backdrop-blur-md"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.5)]"></span><span class="text-sm font-bold text-white tracking-wide">Presentation Ready</span></div><span class="text-xs font-mono text-slate-500 bg-slate-800/50 px-2 py-1 rounded-md border border-white/5">${slides.length} SLIDES</span></div><div class="p-8 text-center bg-gradient-to-b from-slate-900 to-slate-900/50"><h3 class="text-2xl font-bold text-white mb-2 font-heading">${slides[0].title}</h3><p class="text-sm text-slate-400 mb-8 font-light">Includes high-fidelity AI visuals.</p><div class="flex gap-4 justify-center"><button onclick="openCanvas()" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-600/20 transition-all hover:scale-105 active:scale-95"><i data-lucide="monitor-play" class="w-4 h-4"></i> Open Canvas</button><button onclick="downloadPPTFromCanvas()" class="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-sm font-bold flex items-center gap-2 border border-slate-700 hover:border-slate-600 transition-all"><i data-lucide="download" class="w-4 h-4"></i> PPTX</button></div></div></div>`;
            document.getElementById('messagesArea').appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        function appendImageCard(url, prompt) {
            const div = document.createElement('div');
            div.className = "flex gap-4 w-full max-w-4xl mx-auto animate-fade-in";
            div.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center shrink-0 shadow-lg shadow-amber-500/20 mt-1"><i data-lucide="sparkles" class="w-4 h-4 text-white"></i></div><div class="flex-1"><div class="bg-slate-900 border border-slate-800 p-2 rounded-2xl shadow-xl w-fit"><img src="${url}" class="rounded-xl border border-slate-700/50 shadow-2xl max-w-md w-full" /><div class="px-3 py-2 flex justify-between items-center"><p class="text-xs text-slate-500 italic truncate max-w-[200px]">${prompt}</p><a href="${url}" download="nano-art.png" class="p-1.5 hover:bg-slate-800 rounded-lg text-slate-400 hover:text-white transition-colors"><i data-lucide="download" class="w-4 h-4"></i></a></div></div></div>`;
            document.getElementById('messagesArea').appendChild(div);
            lucide.createIcons();
            scrollToBottom();
        }

        // --- File & Utils ---
        function handleFile(e) {
            const f = e.target.files[0]; if(!f) return;
            currentAttachment = f;
            document.getElementById('attachmentPreview').classList.remove('hidden');
            document.getElementById('attachmentPreview').classList.add('flex');
            document.getElementById('attName').innerText = f.name;
        }
        function clearAttachment() { currentAttachment = null; document.getElementById('fileInput').value = ''; document.getElementById('attachmentPreview').classList.add('hidden'); document.getElementById('attachmentPreview').classList.remove('flex'); }
        function continueGen() { document.getElementById('promptInput').value = "Continue"; sendMessage(); }
        function scrollToBottom() { document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight; }
        function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
        function handleEnter(e) { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }}
        function showToast(msg, type='info') { const t = document.getElementById('toast'); t.innerHTML = `<i data-lucide="${type==='success'?'check':type==='error'?'alert-circle':'info'}" class="${type==='success'?'text-emerald-400':type==='error'?'text-red-400':'text-blue-400'} w-5 h-5"></i><span>${msg}</span>`; t.classList.add('show'); lucide.createIcons(); setTimeout(()=>t.classList.remove('show'),3000); }
        function copyText(id) { navigator.clipboard.writeText(document.getElementById(id).innerText); showToast('Copied','success'); }
        function speakText(id) { const txt = document.getElementById(id).innerText; const u = new SpeechSynthesisUtterance(txt); window.speechSynthesis.speak(u); }
        async function fileToBase64(f) { return new Promise((r,j)=>{const rd=new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.onerror=j; rd.readAsDataURL(f);}); }
        async function readExcel(f) { return new Promise((r,j)=>{const rd=new FileReader(); rd.onload=(e)=>{const d=new Uint8Array(e.target.result); const wb=XLSX.read(d,{type:'array'}); r(XLSX.utils.sheet_to_csv(wb.Sheets[wb.SheetNames[0]]));}; rd.onerror=j; rd.readAsArrayBuffer(f);}); }
        function toggleMic() { if(!recognition) return showToast('No voice support','error'); if(isRecording) recognition.stop(); else recognition.start(); isRecording = !isRecording; document.getElementById('micBtn').className = isRecording ? 'p-3 text-red-500 bg-red-500/10 rounded-xl animate-pulse transition-colors' : 'p-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors'; }
        function updateMicIcon() { document.getElementById('micBtn').className = 'p-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors'; }

        // --- Canvas & Export ---
        function openCanvas() { document.getElementById('canvasOverlay').classList.remove('hidden'); setTimeout(()=>document.getElementById('canvasOverlay').classList.remove('opacity-0'),10); renderCanvas(); }
        function closeCanvas() { document.getElementById('canvasOverlay').classList.add('opacity-0'); setTimeout(()=>document.getElementById('canvasOverlay').classList.add('hidden'),300); }
        function setCanvasView(v) { document.getElementById('focusView').classList.toggle('hidden',v==='grid'); document.getElementById('gridView').classList.toggle('hidden',v==='focus'); renderCanvas(); }
        function renderCanvas() {
            const container = document.getElementById('canvasSlideContainer');
            const slide = activeSlides[currentSlideIndex];
            const img = slide.imageData || 'https://via.placeholder.com/1920x1080/0f172a/ffffff?text=AI+Visual';
            let html = slide.layout === 'title' ? 
                `<div class="layout-title"><h1 class="text-6xl font-bold font-heading mb-4 z-10">${slide.title}</h1><p class="text-2xl text-blue-400 z-10">${slide.subtitle||''}</p></div>` : 
                `<div class="layout-split"><div class="layout-content"><h2 class="text-4xl font-bold text-slate-900 mb-2 font-heading">${slide.title}</h2><h3 class="text-xl text-blue-600 mb-8 font-medium">${slide.subtitle||''}</h3><ul class="text-slate-600 space-y-4 text-lg pl-5 list-disc">${slide.points.map(p=>`<li>${p}</li>`).join('')}</ul></div><div class="relative"><img src="${img}" class="layout-img" /></div></div>`;
            container.innerHTML = html;
            document.getElementById('currSlide').innerText = currentSlideIndex + 1;
            document.getElementById('totalSlide').innerText = activeSlides.length;
            document.getElementById('gridContainer').innerHTML = activeSlides.map((s,i)=>`<div onclick="currentSlideIndex=${i};setCanvasView('focus')" class="slide-card aspect-video bg-white relative cursor-pointer hover:ring-2 hover:ring-blue-500"><div class="absolute inset-0 bg-slate-900 flex items-center justify-center text-xs text-white p-2 text-center font-heading">${s.title}</div><div class="absolute bottom-2 right-2 text-[10px] text-slate-500 bg-white/90 px-1.5 rounded">${i+1}</div></div>`).join('');
        }
        function nextSlide() { if(currentSlideIndex<activeSlides.length-1) { currentSlideIndex++; renderCanvas(); } }
        function prevSlide() { if(currentSlideIndex>0) { currentSlideIndex--; renderCanvas(); } }
        
        function handleCanvasKey(e) {
            if(document.getElementById('canvasOverlay').classList.contains('hidden')) return;
            if(e.key === 'ArrowRight') nextSlide();
            if(e.key === 'ArrowLeft') prevSlide();
            if(e.key === 'Escape') closeCanvas();
        }
        window.addEventListener('keydown', handleCanvasKey);

        function downloadPPTFromCanvas() {
            if(!window.PptxGenJS) return showToast('Lib Loading','error');
            const pres = new PptxGenJS(); pres.layout='LAYOUT_16x9'; pres.defineSlideMaster({ title:'MASTER', background:{color:'0F172A'} });
            activeSlides.forEach(s => {
                const sl = pres.addSlide({ masterName:'MASTER' });
                if(s.layout === 'title') {
                    sl.background={color:'020617'}; sl.addText(s.title,{x:1,y:2.5,w:'80%',fontSize:44,color:'FFFFFF',bold:true,align:'center',fontFace:'Outfit'}); sl.addText(s.subtitle||'',{x:1,y:4,w:'80%',fontSize:20,color:'3B82F6',align:'center',fontFace:'Inter'});
                } else {
                    sl.addText(s.title,{x:0.5,y:0.5,w:'90%',fontSize:28,color:'FFFFFF',bold:true,fontFace:'Outfit'});
                    sl.addText(s.points.map(p=>({text:p,options:{fontSize:16,color:'CBD5E1',bullet:true}})),{x:0.5,y:1.5,w:'45%',h:5,valign:'top',fontFace:'Inter'});
                    if(s.imageData) sl.addImage({data:s.imageData,x:5.5,y:1.5,w:4.5,h:4.5});
                }
            });
            pres.writeFile({ fileName: 'SuperGemini_Deck.pptx' });
        }

        async function exportDoc(id, type) {
            const raw = document.getElementById(id).innerText;
            const name = "Super_Gemini_Export";
            if(type === 'docx') {
                const { Document, Packer, Paragraph, TextRun } = window.docx;
                const doc = new Document({ sections: [{ children: raw.split('\n').map(l => new Paragraph(l)) }] });
                const blob = await Packer.toBlob(doc);
                const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name+'.docx'; a.click();
            } else {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(raw.split('\n').map(l=>[l]));
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, name+'.xlsx');
            }
        }
    </script>
</body>
</html>